<?xml version="1.0" encoding="UTF-8"?>

<!--
WRF Nature Run Workflow

Loosely based of the RRFS workflow

shawn.s.murdzek@noaa.gov
-->

<!DOCTYPE workflow [

<!--
Parameters needed by the job scheduler.
-->
<!ENTITY ACCOUNT         "wrfruc">
<!ENTITY SCHED           "slurm">
<!ENTITY QUEUE_DEFAULT   "batch">

<!--
Workflow task names.
-->
<!ENTITY GEOGRID_TN   "geogrid">
<!ENTITY UNGRIB_TN    "ungrib">
<!ENTITY METGRID_TN   "metgrid">
<!ENTITY RUN_REAL_TN  "real">
<!ENTITY RUN_WRF_TN   "wrf">
<!ENTITY RUN_UPP_TN   "upp">
<!ENTITY PYGRAF_TN    "pygraf">

<!ENTITY TAG          "NATURE_RUN">

<!--
Switchess that control whether certain tasks are run
-->
<!ENTITY RUN_TASK_GEOGRID "TRUE">
<!ENTITY RUN_TASK_UPP     "TRUE">
<!ENTITY RUN_TASK_PYGRAF  "TRUE">

<!--
Directories and files.
-->
<!ENTITY SIMDIR                   "/lfs4/BMC/wrfruc/murdzek/nature_run_10km_io102">
<!ENTITY JOBSDIR                  "&SIMDIR;">
<!ENTITY WPSDIR                   "&SIMDIR;/WPS">
<!ENTITY WRFDIR                   "&SIMDIR;/WRF">
<!ENTITY UPP_OUT                  "&SIMDIR;/UPP">
<!ENTITY WF_DIR                   "&SIMDIR;/nature_run_wflow">
<!ENTITY UPP_DIR                  "/lfs4/BMC/wrfruc/murdzek/UPP">
<!ENTITY CRTM                     "/lfs1/BMC/nrtrr/FIX_EXEC_MODULE/crtm/CRTM_v2.2.6">
<!ENTITY PYGRAFDIR                "/lfs4/BMC/wrfruc/murdzek/pygraf">
<!ENTITY GRAPHICSDIR              "&SIMDIR;/graphics">
<!ENTITY FAKEOBS_CODE_DIR         "/lfs4/BMC/wrfruc/murdzek/py_scripts/synthetic_obs">
<!ENTITY FAKEOBS_OUT_DIR          "&SIMDIR;/synthetic_obs">
<!ENTITY RAPDIR                   "/lfs4/BMC/wrfruc/murdzek/RAP_data/grib">
<!ENTITY HRRRDIR                  "/lfs4/BMC/wrfruc/murdzek/HRRR_data">
<!ENTITY STATICDIR                "/lfs4/BMC/wrfruc/murdzek/static_data">
<!ENTITY LOAD_MODULES_RUN_TASK_FP "&SIMDIR;/nature_run_wflow/load_modules_run_task.sh">

<!--
Nature run length and output file increment (in min)
-->
<!ENTITY NATURE_LENGTH "00:01:00:00">
<!ENTITY incrementmin "15">

<!--
Command used to run programs in parallel
-->
<!ENTITY APRUN "srun -n">

<!--
Number of cores for each task
-->
<!ENTITY GEO_CORES  "1">
<!ENTITY MET_CORES  "1">
<!ENTITY REAL_CORES "1">
<!ENTITY WRF_CORES  "10">
<!ENTITY UPP_CORES  "6">
<!ENTITY PYG_CORES  "4">

<!--
Reservation types.  Reservations specify the queue/partition and account
to use for a given task.
-->
<!ENTITY RSRV_DEFAULT "<account>&ACCOUNT;</account><queue>&QUEUE_DEFAULT;</queue><partition>tjet,ujet</partition>">
<!ENTITY RSRV_WRF "<account>&ACCOUNT;</account><queue>&QUEUE_DEFAULT;</queue><partition>xjet</partition>">
<!ENTITY RSRV_UPP "<account>&ACCOUNT;</account><queue>&QUEUE_DEFAULT;</queue><partition>xjet</partition>">


]>
<workflow realtime="F" scheduler="&SCHED;" cyclethrottle="1" cyclelifespan="05:00:00:00">


  <cycledef group="wps"> 202107242300 202107250000 02:00:00 </cycledef>
  <cycledef group="wrf"> 202107242300 202107250000 02:00:00 </cycledef>
  <cycledef group="post"> 202107242300 202107250000 02:00:00 </cycledef>
  <cycledef group="create_obs"> 202107242300 202107250000 02:00:00 </cycledef>

  <log>
    <cyclestr>&JOBSDIR;/NATURE_RUN_wflow.log</cyclestr>
  </log>



<!--
************************************************************************
************************************************************************
-->
  <task name="&GEOGRID_TN;" cycledefs="wps" maxtries="3">

    &RSRV_DEFAULT;
  
    <command>&LOAD_MODULES_RUN_TASK_FP; "bash run_scripts/run_geogrid.sh"</command>
  
    <cores>&GEO_CORES;</cores>
    <walltime>00:30:00</walltime>
    <jobname>&TAG;_&GEOGRID_TN;</jobname>
    <join><cyclestr>&WPSDIR;/&GEOGRID_TN;_@Y@m@d@H.log</cyclestr></join>
    
    <envar><name>WPSDIR</name><value>&WPSDIR;</value></envar>
    <envar><name>APRUN</name><value>&APRUN;</value></envar>
    <envar><name>NPROC</name><value>&GEO_CORES;</value></envar>

    <dependency>
      <and>
        <not>
          <datadep age="00:00:00:10"><cyclestr>&WPSDIR;/geo_em.d01.nc</cyclestr></datadep>
        </not>
        <not>
          <datadep age="00:00:00:10"><cyclestr>&WPSDIR;/geo_em.d01.nc_0000</cyclestr></datadep>
        </not>
        <not>
          <datadep age="00:00:00:10"><cyclestr>&WPSDIR;/geo_em.d01.tar</cyclestr></datadep>
        </not>
        <streq><left>&RUN_TASK_GEOGRID;</left><right>TRUE</right></streq>
      </and>
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
  <task name="&UNGRIB_TN;" cycledefs="wps" maxtries="3">

    &RSRV_DEFAULT;
  
    <command>&LOAD_MODULES_RUN_TASK_FP; "bash run_scripts/run_ungrib.sh"</command>
  
    <nodes>1:ppn=1</nodes>
    <walltime>00:30:00</walltime>
    <jobname>&TAG;_&UNGRIB_TN;</jobname>
    <join><cyclestr>&WPSDIR;/&UNGRIB_TN;_@Y@m@d@H.log</cyclestr></join>

    <envar><name>RAPDIR</name><value>&RAPDIR;</value></envar>
    <envar><name>HRRRDIR</name><value>&HRRRDIR;</value></envar>
    <envar><name>STATICDIR</name><value>&STATICDIR;</value></envar>
    <envar><name>WPSDIR</name><value>&WPSDIR;</value></envar>
    
    <dependency>
      <and>
        <not>
          <datadep age="00:00:00:10"><cyclestr>&WPSDIR;/RAP:@Y-@m-@d_@H</cyclestr></datadep>
        </not>
        <not>
          <datadep age="00:00:00:10"><cyclestr>&WPSDIR;/FILE:@Y-@m-@d_@H</cyclestr></datadep>
        </not>
      </and>
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
  <task name="&METGRID_TN;" cycledefs="wps" maxtries="3">

    &RSRV_DEFAULT;
  
    <command>&LOAD_MODULES_RUN_TASK_FP; "bash run_scripts/run_metgrid.sh"</command>
  
    <cores>&MET_CORES;</cores>
    <walltime>00:30:00</walltime>
    <jobname>&TAG;_&METGRID_TN;</jobname>
    <join><cyclestr>&WPSDIR;/&METGRID_TN;_@Y@m@d@H.log</cyclestr></join>

    <envar><name>WPSDIR</name><value>&WPSDIR;</value></envar>
    <envar><name>APRUN</name><value>&APRUN;</value></envar>
    <envar><name>NPROC</name><value>&MET_CORES;</value></envar>
    
    <dependency>
      <and>
        <not>
          <datadep age="00:00:00:10"><cyclestr>&WPSDIR;/met_em.d01.@Y-@m-@d_@H:@M:@S.nc</cyclestr></datadep>
        </not>
        <not>
          <datadep age="00:00:00:10"><cyclestr>&WPSDIR;/met_em.d01.@Y-@m-@d_@H:@M:@S.nc_0000</cyclestr></datadep>
        </not>
        <not>
          <datadep age="00:00:00:10"><cyclestr>&WPSDIR;/met_em.d01.tar</cyclestr></datadep>
        </not>
        <or>
          <datadep age="00:00:05:00"><cyclestr>&WPSDIR;/geo_em.d01.nc</cyclestr></datadep>
          <datadep age="00:00:05:00"><cyclestr>&WPSDIR;/geo_em.d01.nc_0000</cyclestr></datadep>
        </or>
        <datadep age="00:00:05:00"><cyclestr>&WPSDIR;/RAP:@Y-@m-@d_@H</cyclestr></datadep>
      </and>
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
  <task name="&RUN_REAL_TN;" cycledefs="wrf" maxtries="3">

    &RSRV_DEFAULT;
  
    <command>&LOAD_MODULES_RUN_TASK_FP; "bash run_scripts/run_real.sh"</command>
  
    <cores>&REAL_CORES;</cores>
    <walltime>00:30:00</walltime>
    <jobname>&TAG;_&RUN_REAL_TN;</jobname>
    <join><cyclestr>&WRFDIR;/run/&RUN_REAL_TN;_@Y@m@d@H.log</cyclestr></join>

    <envar><name>WPSDIR</name><value>&WPSDIR;</value></envar>
    <envar><name>WRFDIR</name><value>&WRFDIR;</value></envar>
    <envar><name>APRUN</name><value>&APRUN;</value></envar>
    <envar><name>NPROC</name><value>&REAL_CORES;</value></envar>

    <dependency>
      <and>
        <not>
          <datadep age="00:00:00:10"><cyclestr>&WRFDIR;/run/wrfinput_d01</cyclestr></datadep>
        </not>
        <not>
          <datadep age="00:00:00:10"><cyclestr>&WRFDIR;/run/wrfinput_d01_0000</cyclestr></datadep>
        </not>
        <not>
          <datadep age="00:00:00:10"><cyclestr>&WRFDIR;/run/wrfinput.tar</cyclestr></datadep>
        </not>
        <or>
          <datadep age="00:00:05:00"><cyclestr>&WPSDIR;/met_em.d01.@Y-@m-@d_@H:@M:@S.nc</cyclestr></datadep>
          <datadep age="00:00:05:00"><cyclestr>&WPSDIR;/met_em.d01.@Y-@m-@d_@H:@M:@S.nc_0000</cyclestr></datadep>
        </or>
      </and>
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
  <task name="&RUN_WRF_TN;" cycledefs="wrf" maxtries="3">

    &RSRV_WRF;
  
    <command>&LOAD_MODULES_RUN_TASK_FP; "bash run_scripts/run_wrf.sh"</command>
  
    <cores>&WRF_CORES;</cores>
    <walltime>02:00:00</walltime>
    <jobname>&TAG;_&RUN_WRF_TN;</jobname>
    <join><cyclestr>&WRFDIR;/run/&RUN_WRF_TN;_@Y@m@d@H.log</cyclestr></join>

    <envar><name>WRFDIR</name><value>&WRFDIR;</value></envar>
    <envar><name>APRUN</name><value>&APRUN;</value></envar>
    <envar><name>NPROC</name><value>&WRF_CORES;</value></envar>

    <dependency>
      <and>
        <not>
          <datadep age="00:00:00:10"><cyclestr>&WRFDIR;/run/wrfout_d01_@Y-@m-@d_@H_@M_@S</cyclestr></datadep>
        </not>
        <or>
          <datadep age="00:00:05:00"><cyclestr>&WRFDIR;/run/wrfinput_d01</cyclestr></datadep>
          <datadep age="00:00:05:00"><cyclestr>&WRFDIR;/run/wrfinput_d01_0000</cyclestr></datadep>
        </or>
      </and>
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
  <task name="&RUN_UPP_TN;" cycledefs="post" maxtries="3">

    &RSRV_UPP;
  
    <command>&LOAD_MODULES_RUN_TASK_FP; "bash run_scripts/run_upp.sh"</command>
  
    <cores>&UPP_CORES;</cores>
    <walltime>01:00:00</walltime>
    <jobname>&TAG;_&RUN_UPP_TN;</jobname>
    <join><cyclestr>&UPP_OUT;/&RUN_UPP_TN;_@Y@m@d@H.log</cyclestr></join>

    <envar><name>UPP_OUT</name><value>&UPP_OUT;</value></envar>
    <envar><name>UPP_HOME</name><value>&UPP_DIR;</value></envar>
    <envar><name>WF_DIR</name><value>&WF_DIR;</value></envar>
    <envar><name>modelDataPath</name><value>&WRFDIR;/run</value></envar>
    <envar><name>txtCntrlFile</name><value>&UPP_DIR;/parm/postxconfig-NT-wrf_SSM.txt</value></envar>
    <envar><name>CRTM</name><value>&CRTM;</value></envar>
    <envar><name>startdate</name><value><cyclestr>@Y@m@d@H@M</cyclestr></value></envar>
    <envar><name>lastdate</name><value><cyclestr offset="&NATURE_LENGTH;">@Y@m@d@H@M</cyclestr></value></envar>
    <envar><name>incrementmin</name><value>&incrementmin;</value></envar>
    <envar><name>APRUN</name><value>&APRUN;</value></envar>
    <envar><name>NPROC</name><value>&UPP_CORES;</value></envar>

    <dependency>
      <and>
        <not>
          <datadep age="00:00:00:10"><cyclestr>&UPP_OUT;/wrfnat_@Y@m@d@H@M.grib2</cyclestr></datadep>
        </not>
        <datadep age="00:00:15:00"><cyclestr offset="&NATURE_LENGTH;">&WRFDIR;/run/wrfout_d01_@Y-@m-@d_@H_@M_@S</cyclestr></datadep>
        <streq><left>&RUN_TASK_UPP;</left><right>TRUE</right></streq>
      </and>
    </dependency>

  </task>

<!--
************************************************************************
************************************************************************
-->

  <task name="&PYGRAF_TN;" cycledefs="post" maxtries="3">

    &RSRV_DEFAULT;
  
    <command>&LOAD_MODULES_RUN_TASK_FP; "bash run_scripts/run_pygraf.sh"</command>
  
    <cores>&PYG_CORES;</cores>
    <walltime>00:20:00</walltime>
    <jobname>&TAG;_&PYGRAF_TN;</jobname>
    <join><cyclestr>&GRAPHICSDIR;/&PYGRAF_TN;_@Y@m@d@H.log</cyclestr></join>

    <envar><name>PYGRAFDIR</name><value>&PYGRAFDIR;</value></envar>
    <envar><name>UPP_OUT</name><value>&UPP_OUT;</value></envar>
    <envar><name>GRAPHICSDIR</name><value>&GRAPHICSDIR;</value></envar>
    <envar><name>START</name><value><cyclestr>@Y@m@d@H@M</cyclestr></value></envar>
    <envar><name>END</name><value><cyclestr offset="&NATURE_LENGTH;">@Y@m@d@H@M</cyclestr></value></envar>
    <envar><name>STEP</name><value>&incrementmin;</value></envar>
    <envar><name>NPROC</name><value>&PYG_CORES;</value></envar>

    <dependency>
      <and>
        <datadep age="00:00:05:00"><cyclestr offset="&NATURE_LENGTH;">&UPP_OUT;/wrfnat_@Y@m@d@H@M.grib2</cyclestr></datadep>
        <streq><left>&RUN_TASK_PYGRAF;</left><right>TRUE</right></streq>
      </and>
    </dependency>

  </task>

</workflow>
